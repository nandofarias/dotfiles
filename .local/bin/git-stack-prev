#!/usr/bin/env bash
set -euo pipefail

if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
  echo "Usage: git prev"
  echo "Switch to the parent branch (one step down the stack)."
  exit 0
fi

current=$(git rev-parse --abbrev-ref HEAD)
merge_base=$(git merge-base develop HEAD 2>/dev/null) || { echo "Error: cannot find merge-base with develop"; exit 1; }

current_sha=$(git rev-parse HEAD)

# Walk commits from current back to merge_base, find the first branch that isn't current
parent=""
while IFS= read -r sha; do
  branches=$(git for-each-ref --points-at="$sha" --format='%(refname:short)' refs/heads/ 2>/dev/null)
  for b in $branches; do
    [[ "$b" == "$current" ]] && continue
    parent="$b"
    break 2
  done
done < <(git log --format='%H' --ancestry-path "$merge_base..HEAD" | tail -n +2)

if [[ -z "$parent" ]]; then
  echo "No parent branch found (already at bottom of stack). Switching to develop."
  git switch develop 2>/dev/null || echo "Cannot switch to develop (likely checked out in another worktree)."
  exit 0
fi

git switch "$parent"
