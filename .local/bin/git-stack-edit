#!/usr/bin/env bash
set -euo pipefail

if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
  echo "Usage: git edit [<commit>]"
  echo "Interactive rebase to edit a specific commit in the current branch."
  echo ""
  echo "If <commit> is given (SHA or HEAD~N), starts an interactive rebase"
  echo "with that commit marked for 'edit'. Make your changes, then:"
  echo "  git add -A && git rebase --continue"
  echo ""
  echo "If no <commit> is given, opens a full interactive rebase from the"
  echo "merge-base with develop (so you can reorder, squash, fixup, etc)."
  echo ""
  echo "After completion, child branches are automatically rebased."
  exit 0
fi

RED='\033[0;31m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[0;33m'
RESET='\033[0m'

current=$(git rev-parse --abbrev-ref HEAD)
merge_base=$(git merge-base develop HEAD 2>/dev/null) || {
  echo -e "${RED}Error: cannot find merge-base with develop${RESET}"; exit 1
}

old_sha=$(git rev-parse HEAD)

if [[ -z "${1:-}" ]]; then
  # Full interactive rebase from merge-base
  echo -e "${CYAN}Interactive rebase from merge-base with develop...${RESET}"
  git rebase -i "$merge_base" || {
    echo -e "${YELLOW}Rebase paused. Resolve conflicts, then 'git rebase --continue'.${RESET}"
    echo -e "${YELLOW}After finishing, run 'git edit --continue' to rebase children.${RESET}"
    exit 1
  }
else
  target="$1"
  # Resolve to SHA
  target_sha=$(git rev-parse --short "$target" 2>/dev/null) || {
    echo -e "${RED}Error: cannot resolve '$target'${RESET}"; exit 1
  }

  echo -e "${CYAN}Editing commit ${target_sha}...${RESET}"
  GIT_SEQUENCE_EDITOR="sed -i '' 's/^pick ${target_sha}/edit ${target_sha}/'" \
    git rebase -i "${target_sha}~1" || {
    echo -e "${YELLOW}Rebase paused at ${target_sha}. Make your changes, then:${RESET}"
    echo -e "${YELLOW}  git add -A && git rebase --continue${RESET}"
    exit 0
  }
fi

new_sha=$(git rev-parse HEAD)
if [[ "$old_sha" == "$new_sha" ]]; then
  echo -e "${GREEN}Nothing changed.${RESET}"
  exit 0
fi

# Find and rebase children
children=()
while IFS= read -r line; do
  sha="${line%% *}"
  name="${line#* }"
  [[ "$name" == "develop" || "$name" == "$current" ]] && continue
  mb=$(git merge-base "$old_sha" "$sha" 2>/dev/null) || continue
  if [[ "$mb" == "$old_sha" ]]; then
    dist=$(git rev-list --count "$old_sha..$sha" 2>/dev/null) || continue
    children+=("$dist:$name")
  fi
done < <(git for-each-ref --format='%(objectname) %(refname:short)' refs/heads/)

IFS=$'\n' sorted=($(printf '%s\n' "${children[@]}" | sort -t: -k1 -n)); unset IFS

if [[ ${#sorted[@]} -gt 0 ]]; then
  echo -e "${CYAN}Rebasing children...${RESET}"
  for entry in "${sorted[@]}"; do
    child="${entry#*:}"
    echo -e "  Rebasing ${child}..."
    git rebase --onto "$new_sha" "$old_sha" "$child" || {
      echo -e "${RED}Rebase failed for $child. Resolve and run 'git rebase --continue'.${RESET}"
      exit 1
    }
  done
fi

git switch "$current" 2>/dev/null
echo -e "${GREEN}Done. Children rebased.${RESET}"
