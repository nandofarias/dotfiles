#!/usr/bin/env bash
set -euo pipefail

if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
  echo "Usage: git next"
  echo "Switch to the child branch (one step up the stack)."
  exit 0
fi

current=$(git rev-parse --abbrev-ref HEAD)
merge_base=$(git merge-base develop HEAD 2>/dev/null) || { echo "Error: cannot find merge-base with develop"; exit 1; }

# We need to find branches that point to commits ABOVE current in the full stack
# First, find all branches pointing to descendants of current (children)
current_sha=$(git rev-parse HEAD)

# Find branches whose merge-base with current equals current's SHA (i.e., they're descendants)
child=""
while IFS= read -r line; do
  sha="${line%% *}"
  name="${line#* }"
  [[ "$name" == "develop" || "$name" == "$current" ]] && continue
  mb=$(git merge-base "$current_sha" "$sha" 2>/dev/null) || continue
  if [[ "$mb" == "$current_sha" ]]; then
    # This branch is a descendant; pick the closest one (fewest commits ahead)
    dist=$(git rev-list --count "$current_sha..$sha" 2>/dev/null) || continue
    if [[ -z "$child" || "$dist" -lt "$best_dist" ]]; then
      child="$name"
      best_dist="$dist"
    fi
  fi
done < <(git for-each-ref --format='%(objectname) %(refname:short)' refs/heads/)

if [[ -z "$child" ]]; then
  echo "No child branch found (already at top of stack)."
  exit 1
fi

git switch "$child"
